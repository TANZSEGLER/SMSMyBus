<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="Stop __UP_stopID__"/>
  <UserPref name="stopID" display_name="Stop #" default_value="1101"/>

  <Content type="html">
  
  <![CDATA[
      <link rel="stylesheet" href="/gadgets/style.css">
  
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script> 
    <script type="text/javascript" src="/js/jquery.timers-1.2.js"></script>
    <script type="text/javascript">
      function refreshTimes(stopID, Direction) {
          params = {};
          params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.DOM;
    	  gadgets.io.makeRequest("http://gadget.latest.smsmybus.appspot.com/rest/"+stopID+"/",response,params);
      } // refreshTimes
      
      function response(obj) {
          var xml = obj.data;
          
   	      if($("status",xml).text() == "-1") {
          	   $("#1505-estimates").replaceWith('<p id="1505-estimates" style="color:red;font-weight: bold">Error retrieving stop arrival data!</p>');
     	  } else {
          	   stopDispID = $("stop",xml).text();
       	       timestamp = $("timestamp",xml).text();
          	   $("#1505-estimates").replaceWith('<div id="1505-estimates" class="estimates"><div class="subhead">Few on Ingersoll '+timestamp+' estimate</div>');
          	   
          	   i=0; //row index, will be counting numbers      	   
      	       $("route",xml).each(function(id) {
          	       var routeID = $(this).find('routeID').text();
          	       var minutes = $(this).find('minutes').text();
      	           if (++i>4) {
      	               $("#1505-estimates").append('<span class="arrival"> ...#'+routeID+' in '+minutes+' min </span>'); 
      	               return true;
      	           } //limit number of rows
          	       var human = $(this).find('human').text();
          	       var arrival = $(this).find('arrivalTime').text();
          	       var destination = $(this).find('destination').text();
          	       destination = destination.substring(0,12); //limit the length in case of long ones (unknown risk)
                   if (minutes<6) {
                       time = '<div class="arrival"><span class="coming-soon">#<span class="route-label">'+routeID+'</span> to <span class="destination-abbrev">'+destination+'</span> in <span class="minutes">'+minutes+'</span> min</span></div><div class="destination-text">'+destination+'</span></div>';
                   } else {
                       time = '<div class="arrival">#<span class="route-label">'+routeID+'</span> to <span class="destination-abbrev">'+destination+'</span> in <span class="minutes">'+minutes+'</span> min</span></div><div class="destination-text">'+destination+'</div>';
                   }
      	          $("#1505-estimates").append(time);        	          
        	   });
      	   }   
       } // success function
      $(document).everyTime("31s",function() {
          //Note: this is now stupid, make the document.ready call a named function
          updateClock();
          refreshTimes('1505', '<< Eastbound');
	   });
    </script>

    <script type="text/javascript">
      $(document).ready(function() {
          updateClock();
          refreshTimes('1505', '<< Eastbound');
      });
    </script>
    
    <script type="text/javascript">
    <!--

	function updateClock ( )
	{
	  var currentTime = new Date ( );
	
	  var currentHours = currentTime.getHours ( );
	  var currentMinutes = currentTime.getMinutes ( );
	  var currentSeconds = currentTime.getSeconds ( );
	
	  // Pad the minutes and seconds with leading zeros, if required
	  currentMinutes = ( currentMinutes < 10 ? "0" : "" ) + currentMinutes;
	  currentSeconds = ( currentSeconds < 10 ? "0" : "" ) + currentSeconds;
	
	  // Choose either "AM" or "PM" as appropriate
	  var timeOfDay = ( currentHours < 12 ) ? "am" : "pm";
	
	  // Convert the hours component to 12-hour format if needed
	  currentHours = ( currentHours > 12 ) ? currentHours - 12 : currentHours;
	
	  // Convert an hours component of "0" to "12"
	  currentHours = ( currentHours == 0 ) ? 12 : currentHours;
	
	  // Compose the string for display
	  var currentTimeString = currentHours + ":" + currentMinutes + " " + timeOfDay;
	
	  // Update the time display
	  document.getElementById("clock").firstChild.nodeValue = currentTimeString;
	}
	
	// -->
	</script>
    	<div id="clock">clock</div>
        <div class="estimates" id="1505-estimates">new alert</div>
    ]]>
    
  </Content>

</Module>
